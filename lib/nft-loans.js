const TellerV2ABI = [{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"previousAdmin","type":"address"},{"indexed":false,"internalType":"address","name":"newAdmin","type":"address"}],"name":"AdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"beacon","type":"address"}],"name":"BeaconUpgraded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"implementation","type":"address"}],"name":"Upgraded","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"admin_","type":"address"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newAdmin","type":"address"}],"name":"changeAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"implementation","outputs":[{"internalType":"address","name":"implementation_","type":"address"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newImplementation","type":"address"}],"name":"upgradeTo","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newImplementation","type":"address"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"upgradeToAndCall","outputs":[],"stateMutability":"payable","type":"function"},{"stateMutability":"payable","type":"receive"},{"inputs":[{"internalType":"uint256","name":"bidId","type":"uint256"},{"internalType":"string","name":"action","type":"string"},{"internalType":"string","name":"message","type":"string"}],"name":"ActionNotAllowed","type":"error"},{"inputs":[{"internalType":"uint256","name":"bidId","type":"uint256"},{"internalType":"uint256","name":"payment","type":"uint256"},{"internalType":"uint256","name":"minimumOwed","type":"uint256"}],"name":"PaymentNotMinimum","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"bidId","type":"uint256"},{"indexed":true,"internalType":"address","name":"lender","type":"address"}],"name":"AcceptedBid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"bidId","type":"uint256"}],"name":"CancelledBid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"bidId","type":"uint256"},{"indexed":true,"internalType":"string","name":"feeType","type":"string"},{"indexed":true,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeePaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"bidId","type":"uint256"},{"indexed":true,"internalType":"address","name":"liquidator","type":"address"}],"name":"LoanLiquidated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"bidId","type":"uint256"}],"name":"LoanRepaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"bidId","type":"uint256"}],"name":"LoanRepayment","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"marketId","type":"uint256"},{"indexed":true,"internalType":"address","name":"forwarder","type":"address"},{"indexed":false,"internalType":"address","name":"sender","type":"address"}],"name":"MarketForwarderApproved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"newFee","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"oldFee","type":"uint16"}],"name":"ProtocolFeeSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"bidId","type":"uint256"},{"indexed":true,"internalType":"address","name":"borrower","type":"address"},{"indexed":false,"internalType":"address","name":"receiver","type":"address"},{"indexed":true,"internalType":"bytes32","name":"metadataURI","type":"bytes32"}],"name":"SubmittedBid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"marketId","type":"uint256"},{"indexed":false,"internalType":"address","name":"forwarder","type":"address"},{"indexed":false,"internalType":"address","name":"sender","type":"address"}],"name":"TrustedMarketForwarderSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[],"name":"CURRENT_CODE_VERSION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"_lenderVolumeFilled","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"_totalVolumeFilled","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_lendingToken","type":"address"}],"name":"addLendingToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_marketId","type":"uint256"},{"internalType":"address","name":"_forwarder","type":"address"}],"name":"approveMarketForwarder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"bidDefaultDuration","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"bidExpirationTime","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"bidId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"bids","outputs":[{"internalType":"address","name":"borrower","type":"address"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"address","name":"lender","type":"address"},{"internalType":"uint256","name":"marketplaceId","type":"uint256"},{"internalType":"bytes32","name":"_metadataURI","type":"bytes32"},{"components":[{"internalType":"contract ERC20","name":"lendingToken","type":"address"},{"internalType":"uint256","name":"principal","type":"uint256"},{"components":[{"internalType":"uint256","name":"principal","type":"uint256"},{"internalType":"uint256","name":"interest","type":"uint256"}],"internalType":"struct TellerV2Storage_G0.Payment","name":"totalRepaid","type":"tuple"},{"internalType":"uint32","name":"timestamp","type":"uint32"},{"internalType":"uint32","name":"acceptedTimestamp","type":"uint32"},{"internalType":"uint32","name":"lastRepaidTimestamp","type":"uint32"},{"internalType":"uint32","name":"loanDuration","type":"uint32"}],"internalType":"struct TellerV2Storage_G0.LoanDetails","name":"loanDetails","type":"tuple"},{"components":[{"internalType":"uint256","name":"paymentCycleAmount","type":"uint256"},{"internalType":"uint32","name":"paymentCycle","type":"uint32"},{"internalType":"uint16","name":"APR","type":"uint16"}],"internalType":"struct TellerV2Storage_G0.Terms","name":"terms","type":"tuple"},{"internalType":"enum TellerV2Storage_G0.BidState","name":"state","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"borrowerBids","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"},{"internalType":"uint256","name":"_timestamp","type":"uint256"}],"name":"calculateAmountDue","outputs":[{"components":[{"internalType":"uint256","name":"principal","type":"uint256"},{"internalType":"uint256","name":"interest","type":"uint256"}],"internalType":"struct TellerV2Storage_G0.Payment","name":"due","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"calculateAmountDue","outputs":[{"components":[{"internalType":"uint256","name":"principal","type":"uint256"},{"internalType":"uint256","name":"interest","type":"uint256"}],"internalType":"struct TellerV2Storage_G0.Payment","name":"due","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"},{"internalType":"uint256","name":"_timestamp","type":"uint256"}],"name":"calculateAmountOwed","outputs":[{"components":[{"internalType":"uint256","name":"principal","type":"uint256"},{"internalType":"uint256","name":"interest","type":"uint256"}],"internalType":"struct TellerV2Storage_G0.Payment","name":"owed","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"calculateNextDueDate","outputs":[{"internalType":"uint32","name":"dueDate_","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"cancelBid","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"getBidState","outputs":[{"internalType":"enum TellerV2Storage_G0.BidState","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_borrower","type":"address"}],"name":"getBorrowerActiveLoanIds","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_borrower","type":"address"}],"name":"getBorrowerLoanIds","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLendingTokens","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"getLoanBorrower","outputs":[{"internalType":"address","name":"borrower_","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"getLoanLender","outputs":[{"internalType":"address","name":"lender_","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"getMetadataURI","outputs":[{"internalType":"string","name":"metadataURI_","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_marketId","type":"uint256"},{"internalType":"address","name":"_forwarder","type":"address"},{"internalType":"address","name":"_account","type":"address"}],"name":"hasApprovedMarketForwarder","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint16","name":"_protocolFee","type":"uint16"},{"internalType":"address","name":"_marketRegistry","type":"address"},{"internalType":"address","name":"_reputationManager","type":"address"},{"internalType":"address","name":"_lenderCommitmentForwarder","type":"address"},{"internalType":"address[]","name":"_lendingTokens","type":"address[]"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"isLoanDefaulted","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"isLoanExpired","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"isPaymentLate","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"forwarder","type":"address"}],"name":"isTrustedForwarder","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_marketId","type":"uint256"},{"internalType":"address","name":"_trustedMarketForwarder","type":"address"}],"name":"isTrustedMarketForwarder","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"lastRepaidTimestamp","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"lenderAcceptBid","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"lenderCommitmentForwarder","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"lenderVolumeFilled","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"liquidateLoanFull","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"marketRegistry","outputs":[{"internalType":"contract IMarketRegistry","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"onUpgrade","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauseProtocol","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"protocolFee","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_lendingToken","type":"address"}],"name":"removeLendingToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"repayLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"repayLoanFull","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_bidId","type":"uint256"}],"name":"repayLoanMinimum","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"reputationManager","outputs":[{"internalType":"contract IReputationManager","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint16","name":"newFee","type":"uint16"}],"name":"setProtocolFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_reputationManager","type":"address"}],"name":"setReputationManager","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_marketId","type":"uint256"},{"internalType":"address","name":"_forwarder","type":"address"}],"name":"setTrustedMarketForwarder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_lendingToken","type":"address"},{"internalType":"uint256","name":"_marketplaceId","type":"uint256"},{"internalType":"uint256","name":"_principal","type":"uint256"},{"internalType":"uint32","name":"_duration","type":"uint32"},{"internalType":"uint16","name":"_APR","type":"uint16"},{"internalType":"string","name":"_metadataURI","type":"string"},{"internalType":"address","name":"_receiver","type":"address"}],"name":"submitBid","outputs":[{"internalType":"uint256","name":"bidId_","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totalVolumeFilled","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseProtocol","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"uris","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"version","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_logic","type":"address"},{"internalType":"address","name":"admin_","type":"address"},{"internalType":"bytes","name":"_data","type":"bytes"}],"stateMutability":"payable","type":"constructor"}]

const BNPLMarketABI = [{"inputs":[{"internalType":"address","name":"_tellerV2","type":"address"},{"internalType":"address","name":"_marketRegistry","type":"address"},{"internalType":"uint256","name":"_marketId","type":"uint256"},{"internalType":"address","name":"_wethAddress","type":"address"},{"internalType":"address","name":"_trustedForwarder","type":"address"},{"internalType":"address","name":"_craSigner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"discreteOrderId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bidId","type":"uint256"}],"name":"AcceptedDiscreteOrder","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"bidId","type":"uint256"},{"indexed":true,"internalType":"address","name":"borrower","type":"address"},{"indexed":true,"internalType":"address","name":"lender","type":"address"}],"name":"AssetPurchaseWithLoan","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"discreteOrderId","type":"uint256"}],"name":"CancelledDiscreteOrder","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"bidId","type":"uint256"},{"indexed":false,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"address","name":"tokenContract","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ClaimedAsset","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"discreteOrderId","type":"uint256"},{"indexed":true,"internalType":"address","name":"borrower","type":"address"}],"name":"CreatedDiscreteOrder","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8","name":"version","type":"uint8"}],"name":"Initialized","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"_feeRecipient","type":"address"},{"indexed":false,"internalType":"bool","name":"allowed","type":"bool"}],"name":"SetAllowedFeeRecipient","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"pct","type":"uint16"}],"name":"SetReferralReward","type":"event"},{"inputs":[],"name":"CONTRACT_NAME","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"CONTRACT_VERSION","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"CRA_SIGNER","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DOMAIN_SEPARATOR","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ETH_ADDRESS","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"__assetReceiptRegister","outputs":[{"internalType":"address","name":"assetContractAddress","type":"address"},{"internalType":"uint256","name":"assetTokenId","type":"uint256"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"_marketRegistry","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"_tellerV2","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_discreteOrderId","type":"uint256"},{"components":[{"internalType":"address","name":"considerationToken","type":"address"},{"internalType":"uint256","name":"considerationIdentifier","type":"uint256"},{"internalType":"uint256","name":"considerationAmount","type":"uint256"},{"internalType":"address payable","name":"offerer","type":"address"},{"internalType":"address","name":"zone","type":"address"},{"internalType":"address","name":"offerToken","type":"address"},{"internalType":"uint256","name":"offerIdentifier","type":"uint256"},{"internalType":"uint256","name":"offerAmount","type":"uint256"},{"internalType":"enum BasicOrderType","name":"basicOrderType","type":"uint8"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bytes32","name":"zoneHash","type":"bytes32"},{"internalType":"uint256","name":"salt","type":"uint256"},{"internalType":"bytes32","name":"offererConduitKey","type":"bytes32"},{"internalType":"bytes32","name":"fulfillerConduitKey","type":"bytes32"},{"internalType":"uint256","name":"totalOriginalAdditionalRecipients","type":"uint256"},{"components":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address payable","name":"recipient","type":"address"}],"internalType":"struct AdditionalRecipient[]","name":"additionalRecipients","type":"tuple[]"},{"internalType":"bytes","name":"signature","type":"bytes"}],"internalType":"struct BasicOrderParameters","name":"_basicOrderParameters","type":"tuple"}],"name":"acceptDiscreteOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"allowedFeeRecipients","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_discreteOrderId","type":"uint256"}],"name":"cancelDiscreteOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"bidId","type":"uint256"}],"name":"claimNFTFromDefaultedLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"bidId","type":"uint256"}],"name":"claimNFTFromRepaidLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"cryptopunksEscrowBuyer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"cryptopunksMarketAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"discreteOrderCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"discreteOrders","outputs":[{"internalType":"address","name":"borrower","type":"address"},{"components":[{"internalType":"address","name":"lender","type":"address"},{"internalType":"uint256","name":"totalPurchasePrice","type":"uint256"},{"internalType":"uint256","name":"principal","type":"uint256"},{"internalType":"uint256","name":"downPayment","type":"uint256"},{"internalType":"uint32","name":"duration","type":"uint32"},{"internalType":"uint32","name":"signatureExpiration","type":"uint32"},{"internalType":"uint16","name":"interestRate","type":"uint16"},{"internalType":"string","name":"metadataURI","type":"string"},{"internalType":"address","name":"referralAddress","type":"address"}],"internalType":"struct BNPLMarket.SubmitBidArgs","name":"submitBidArgs","type":"tuple"},{"internalType":"address","name":"assetContractAddress","type":"address"},{"internalType":"uint256","name":"assetTokenId","type":"uint256"},{"internalType":"uint256","name":"quantity","type":"uint256"},{"internalType":"uint256","name":"bidId","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"escrowedTokensForLoan","outputs":[{"internalType":"enum IBNPLMarket.TokenType","name":"tokenType","type":"uint8"},{"internalType":"address","name":"tokenAddress","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"tokenClaimed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"components":[{"internalType":"address","name":"lender","type":"address"},{"internalType":"uint256","name":"totalPurchasePrice","type":"uint256"},{"internalType":"uint256","name":"principal","type":"uint256"},{"internalType":"uint256","name":"downPayment","type":"uint256"},{"internalType":"uint32","name":"duration","type":"uint32"},{"internalType":"uint32","name":"signatureExpiration","type":"uint32"},{"internalType":"uint16","name":"interestRate","type":"uint16"},{"internalType":"string","name":"metadataURI","type":"string"},{"internalType":"address","name":"referralAddress","type":"address"}],"internalType":"struct BNPLMarket.SubmitBidArgs","name":"_submitBidArgs","type":"tuple"},{"components":[{"internalType":"address","name":"considerationToken","type":"address"},{"internalType":"uint256","name":"considerationIdentifier","type":"uint256"},{"internalType":"uint256","name":"considerationAmount","type":"uint256"},{"internalType":"address payable","name":"offerer","type":"address"},{"internalType":"address","name":"zone","type":"address"},{"internalType":"address","name":"offerToken","type":"address"},{"internalType":"uint256","name":"offerIdentifier","type":"uint256"},{"internalType":"uint256","name":"offerAmount","type":"uint256"},{"internalType":"enum BasicOrderType","name":"basicOrderType","type":"uint8"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bytes32","name":"zoneHash","type":"bytes32"},{"internalType":"uint256","name":"salt","type":"uint256"},{"internalType":"bytes32","name":"offererConduitKey","type":"bytes32"},{"internalType":"bytes32","name":"fulfillerConduitKey","type":"bytes32"},{"internalType":"uint256","name":"totalOriginalAdditionalRecipients","type":"uint256"},{"components":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address payable","name":"recipient","type":"address"}],"internalType":"struct AdditionalRecipient[]","name":"additionalRecipients","type":"tuple[]"},{"internalType":"bytes","name":"signature","type":"bytes"}],"internalType":"struct BasicOrderParameters","name":"_basicOrderParameters","type":"tuple"},{"internalType":"bytes","name":"_signature","type":"bytes"}],"name":"execute","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"executedSignatures","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMarketRegistry","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTellerV2","outputs":[{"internalType":"contract TellerV2","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"marketId","type":"uint256"}],"name":"getTellerV2MarketOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"address","name":"lender","type":"address"},{"internalType":"uint256","name":"totalPurchasePrice","type":"uint256"},{"internalType":"uint256","name":"principal","type":"uint256"},{"internalType":"uint256","name":"downPayment","type":"uint256"},{"internalType":"uint32","name":"duration","type":"uint32"},{"internalType":"uint32","name":"signatureExpiration","type":"uint32"},{"internalType":"uint16","name":"interestRate","type":"uint16"},{"internalType":"string","name":"metadataURI","type":"string"},{"internalType":"address","name":"referralAddress","type":"address"}],"internalType":"struct BNPLMarket.SubmitBidArgs","name":"_submitBidArgs","type":"tuple"},{"internalType":"address","name":"assetContractAddress","type":"address"},{"internalType":"uint256","name":"assetTokenId","type":"uint256"},{"internalType":"uint256","name":"assetQuantity","type":"uint256"},{"internalType":"uint256","name":"totalPurchasePrice","type":"uint256"},{"internalType":"address","name":"paymentToken","type":"address"}],"name":"getTypeHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"_cryptopunksMarketAddress","type":"address"},{"internalType":"address","name":"_seaportEscrowBuyer","type":"address"},{"internalType":"address","name":"_cryptopunksEscrowBuyer","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"forwarder","type":"address"}],"name":"isTrustedForwarder","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"marketId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_cryptopunksMarketAddress","type":"address"},{"internalType":"address","name":"_cryptopunksEscrowBuyer","type":"address"},{"internalType":"address","name":"_seaportEscrowBuyer","type":"address"}],"name":"onUpgrade","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"domainSeparator","type":"bytes32"},{"internalType":"bytes32","name":"typeHash","type":"bytes32"},{"internalType":"bytes","name":"_signature","type":"bytes"}],"name":"recoverSignature","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"referralRewardPercent","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"seaportEscrowBuyer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_feeRecipient","type":"address"},{"internalType":"bool","name":"_allowed","type":"bool"}],"name":"setAllowedFeeRecipient","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_pct","type":"uint16"}],"name":"setReferralRewardPercent","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"address","name":"lender","type":"address"},{"internalType":"uint256","name":"totalPurchasePrice","type":"uint256"},{"internalType":"uint256","name":"principal","type":"uint256"},{"internalType":"uint256","name":"downPayment","type":"uint256"},{"internalType":"uint32","name":"duration","type":"uint32"},{"internalType":"uint32","name":"signatureExpiration","type":"uint32"},{"internalType":"uint16","name":"interestRate","type":"uint16"},{"internalType":"string","name":"metadataURI","type":"string"},{"internalType":"address","name":"referralAddress","type":"address"}],"internalType":"struct BNPLMarket.SubmitBidArgs","name":"_submitBidArgs","type":"tuple"},{"internalType":"address","name":"_assetContractAddress","type":"address"},{"internalType":"uint256","name":"_assetTokenId","type":"uint256"},{"internalType":"uint256","name":"_quantity","type":"uint256"}],"name":"submitDiscreteOrder","outputs":[{"internalType":"uint256","name":"discreteOrderId","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"tokenAddress","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"enum IBNPLMarket.TokenType","name":"tokenType","type":"uint8"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferLegacyAssetToEscrow","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"tokenAddresses","type":"address[]"},{"internalType":"uint256[]","name":"tokenIds","type":"uint256[]"},{"internalType":"enum IBNPLMarket.TokenType[]","name":"tokenTypes","type":"uint8[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"name":"transferLegacyAssetsArrayToEscrow","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"upgradedToVersion","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"wethAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}]

$(document).ready(() => {
    $("#nft-loan-template").hide()
    let chainId = 1
    let alchemyApiKey = "AEtZpckav3marVzv5FPIbDyddDAkewJ6"
    let provider
    let network = "ethereum"

    $(window).on('connected', async(evt, prov) => {
        provider = new ethers.providers.Web3Provider(prov)
        signer = provider.getSigner()
        chainId = parseInt(prov.chainId)
        await checkNftLoans()
    })

    async function checkNftLoans() {
        let bnplAddress = '0x260C32eB38D1403bd51B83B5b7047812C70B7845' // mainnet
        if (chainId == 5) {
            bnplAddress = '0xC6091F3eDf31fA82E15D32Fe18B1cf21c094AEaA' // goerli
            network = "goerli"
        }

        const bnplContract = new ethers.Contract(bnplAddress, BNPLMarketABI, provider).connect(signer)
        const marketId = await bnplContract.marketId()

        // Create TellerV2 contract instance
        let tellerV2Address = '0x00182FdB0B880eE24D428e3Cc39383717677C37e' // mainnet
        if (chainId == 5) {
            tellerV2Address = '0x1D0eBC060f2897dAc14E482De600cea7896c0A3E' // goerli
        }

        const tellerV2Contract = new ethers.Contract(tellerV2Address, TellerV2ABI, provider)

        // Get borrower bids
        const add = await signer.getAddress() 
        const bidIds = await tellerV2Contract.getBorrowerLoanIds(add)

        const bids = (await Promise.all(bidIds.map(async(bidId) => {
                return {... (await tellerV2Contract.bids(bidId.toString())), bidId}
            })
        ))
        const marketBids = bids.filter(obj => obj.marketplaceId.toString() === marketId.toString())

        const applicableBids = marketBids.filter(obj => obj.state === 3 | 4 | 5) // Bids that have been accepted, repaid, or liquidated

        const baseURL = `https://eth-mainnet.alchemyapi.io/nft/v2/${alchemyApiKey}/getNFTMetadata`
        
        var reqOptions = {
            method: 'GET',
            redirect: 'follow'
            }

        if (applicableBids.length > 0) {
            for (let i = 0; i < applicableBids.length ; i++) {
                const escrowedTokenDetails = await bnplContract.escrowedTokensForLoan(
                    applicableBids[i].bidId.toString()
                    )

                const now = Math.floor(new Date().getTime() /1000)

                const amountOwed = await tellerV2Contract.calculateAmountOwed(applicableBids[i].bidId.toString(), now)

                const debt = Number(ethers.utils.formatEther(amountOwed.principal.add(amountOwed.interest))).toFixed(2)

                const nextDueDate = await tellerV2Contract.calculateNextDueDate(applicableBids[i].bidId.toString())

                const exp = new Date(nextDueDate * 1000).toLocaleDateString()

                if (!escrowedTokenDetails.tokenClaimed && escrowedTokenDetails.tokenAddress != "0x0000000000000000000000000000000000000000") {

                    const fetchURL = `${baseURL}?contractAddress=${escrowedTokenDetails.tokenAddress}&tokenId=${escrowedTokenDetails.tokenId}`

                    fetch(fetchURL, reqOptions)
                        .then(response => response.json())
                        .then(result => {
                            const name = result.metadata.name ? result.metadata.name : result.contractMetadata.name
                            
                            let imageLink = result.metadata.image ? result.metadata.image : result.metadata.image_data
                            
                            imageLink = imageLink.replace("ipfs://", "https://ipfs.io/ipfs/")

                            const id = result.id.tokenId

                            // Create row
                            const newRow = $("#nft-loan-template").clone()
                            newRow.appendTo("#nft-loan-container-grid")
                            newRow.show()
                            newRow.attr('id', `${id}`)

                            // Display data
                            newRow.find(`#nft-loan-title`).text(name)
                            newRow.find(`#nft-loan-image`).attr('src', imageLink)
                            newRow.find(`#nft-loan-debt`).text(debt)
                            newRow.find(`#nft-loan-expiration`).text(`${exp}`)

                            if (applicableBids[i].state == 3) {
                                newRow.find(`#repay-claim-nft`).attr('href', `https://app.teller.org/${network}/profile/${add}/borrower`)
                            }
                            if (applicableBids[i].state == 4) {
                                newRow.find(`#repay-claim-nft`).text('Claim NFT')
                                newRow.find(`#repay-claim-nft`).on('click', async() => {
                                    const { wait } = await bnplContract.claimNFTFromRepaidLoan(applicableBids[i].bidId, {gasLimit: "300000"}) 
                                    const receipt = await wait()
                                })

                            }
                            if (applicableBids[i].state == 5) {
                                newRow.find(`#repay-claim-nft`).text('Liquidated')
                                newRow.find(`#repay-claim-nft`).prop('disabled', true)
                            }
                        })
                }
            }
        }
    }
})